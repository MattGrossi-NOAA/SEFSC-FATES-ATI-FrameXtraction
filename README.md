# imageXtraction
 Simple tool for extracting frames from stereo videos and saving as images

## To Do
The following features or functionalities need to implemented. They are also filed as Issues.
- [ ] Include length in image filename
- [ ] Add ability to control where images are saved -- same directory as videos will not work
- [ ] Store images in subdirectories based on species

For now, only extract the frame specified in the data table and only those frames that contain one of any given species.

*Add desired features or functionalities to this list as needed.*

## Overview
This script a database spreadsheet generated by stereo video annotators an extracts the frame number corresponding to each annotation in each stereo video. Currently, frames are expected to be in columns named ```FrameLeft``` and ```FrameRight``` for left- and right- channel video files listed in columns named ```FilenameLeft``` and ```FilenameRight```, respectively. For example, if annotation *x* occurs in frame 45 in FilenameLeft and frame 50 in FilenameRight, then frame 45 will be extracted from FilenameLeft and frame 50 extracted from FilenameRight. Optionally, a window can be passed to extract a specified number of frames on each side of the specified frame number -- see below for details. Images are written as jpg files following the naming convention:

```
videoFileName_frame-N_length-L_sample-S.jpg
```

where N is the zero-padded frame number extracted from video ```videoFileName```, L is the length of the annotated fish in the image, and S is the index number of the individual fish annotated in the given video. New image files are saved in a directory called ```images``` in the parent directory of the video files unless directed otherwise (see below) with subdirectories for each family, genus, and species. These subdirectories are automatically created if they does not exist at the time an image is written.

## Usage

The preferred method of usage is to run the script within its [Docker container](https://www.docker.com/). You will need to [install Docker](https://www.docker.com/) or [Docker Desktop](https://www.docker.com/products/docker-desktop/) (recommended) locally for this to work. The container includes the following components:
1. **frameXtract.py**: Python script
2. **requirements.txt**: Python library dependencies
3. **Dockerfile** and **docker-compose.yml**: Docker container configuration files

### Method 1: Docker container from GitHub (preferred)
1. Install [GitHub Desktop](https://desktop.github.com/) or [GitHub Command Line Interface (CLI)](https://cli.github.com/).
2. [Clone this GitHub repository](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository). Alternatively, download the files listed above from the repository, either separately or as a .zip package, ensuring that they are all co-located in the same directory.
   
    a. By default, the Python script, the database file, and video files are all expected to be in the same directory, and the images will also be written to this same directory. In this case, either download the container files into the same directory as the database and video files, or download the container files into a new directory and then copy or move the database and video files into that directory.
   
    b. If the database file and video files are in separate directories, and/or if the images are to be written elsewhere, the ```docker-compose.yml``` file needs to be modified as follows:
      *  *Database file*: Under the 'volumes' heading, replace the "." before the colon (:) for the annotations directory with the full local directory of the database file. For example, if the database file is on a local Windows desktop, the new entry should read:
      ```
      volumes:
        - .:/home/app
        - .:/home/app/images
        - .:/home/app/videos
        - C:\Users\user.name\Desktop:/home/app/annotations
      ```
      * *Video files*: Replace the "." before the colon (:) for the videos directory with the full local directory containing the video files. For example, if the video files are on another drive, the new entry might read:
      ```
      volumes:
        - .:/home/app
        - .:/home/app/images
        - D:\myVideos:/home/app/videos
        - C:\Users\user.name\Desktop:/home/app/annotations
      ```
      * *Image files*: To change where the images are written locally, replace the "." before the colon (:) with the full local directory for the new image files. For example, if the image files are to be written in the local Documents folder:
      ```
      volumes:
        - .:/home/app
        - C:\Users\user.name\Documents\images:/home/app/images
        - D:\myVideos:/home/app/videos
        - C:\Users\user.name\Desktop:/home/app/annotations
      ``` 
    Some things to note:
    1. Docker is platform-agnostic. Mac OS or Linux directory chains can be used here as well.
    2. One can set any or all of the images, videos, or the annotations directories. Any combination will work. The leading period (.) means "here" and is used to specify the current directory. Thus, if either the videos or the database annotations file are located in the same directory as the program, the volume mapping should retain the default ".".
    3. The first path (```.:/home/app```) should not be altered unless you understand Docker and know what you are doing. Same with the directory chains *after* the colons.
    4. This part of ```docker-compose.yml``` maps local directories to independent directories inside the container. The container will only be able to see the contents of local directories mounted here. If you run into "file not found" errors, look here first.
  
 4. Open a Command Prompt (Windows) or Terminal (Mac) and navigate to the directory containing this program.
 5. Build the Docker container:
    ```shell
    docker-compose build
    ```
 6. To execute, run
    ```shell
    docker-compose run framextract -f databaseFilename.ext
    ```
    where ```databaseFilename.ext``` is the name of the annotations database file. (Do not pass the full directory chain; just the file name.) Additional options are described below.

### Method 2: As a stand-alone Python script
1. [Clone this GitHub repository](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository). Alternatively, download the script file ```frameXtract.py``` and the package dpendency file ```requirements.txt''' from the repository.
2. Download and install [Python]{https://www.python.org/downloads/} if needed. This program was written in Python 3.11.
3. **Highly recommended:** Create a virtual environment and install the package dependencies in ```requirements.txt```.
4. Execute by passing a *full directory path* for the database annotation file to "-f" or "--file" **and** a full directory path for the videos to "-v" or "--video". This will tell the script that it is being run stand-alone instead of within a container:
   ```shell
   python framextract.py --file full/path/to/databaseFilename.ext --video full/path/to/videoFiles.ext
   ```
   Note that this method may be finicky due to potential version conflicts if the virtual environment does not get set up proeprly.

## Options

This program contains a number of options to customize usage, a summary of which can be accessed by passing the "-h" or "--help" flag, for example:
```shell
docker-compose run framextract -h
```

### -f, --file: database filename
This is the only required argument. It specifies the annotation database file to consult for extracting frames. It must contain the video file names -- in columns labeled ```FilenameLeft``` and ```FilenameRight``` for the two stereo cameras -- and the frame numbers to extract from each file in columns labeled ```FrameLeft``` and ```FrameRight```, respectively.

Example:
```shell
docker-compose run framextract -f databaseFilename.ext
```

### -s, --sep: separator
This specifies the separator (delimiter) for the database file. If no separator is provided at execution, the script tries to determine the separator from the file extention (e.g., "tsv"==tab-delimited, "csv"==comma-separated) or let the Python parsing engine try to automatically determine it. If these attempts fail, the program will exit and the user will be prompted to re-launch using this flag. This flag is generally not needed in most cases if the file is tab or comma separated, as the the automatic determination should rarely fail in either of these cases.

Example:
```shell
docker-compose run framextract --file databaseFilename.ext --sep \t 
```

### -w, --window: window for frame extraction
For some applications, it may be more appropriate to extract a range of frames rather than a single frame. This flag allows the user to specify a number of frames before and after the frame number reported in the database file to extract. For example, if this is set to 5 and the database file contains an annotation at frame 45, then frames 40-50 will be extracted and saved separately (45$\pm$5). For a video recorded at 10 frames per second, this corresponds to one second worth of frames.

Example:
```shell
docker-compose run framextract --file databaseFilename.ext --window 5
```

### -v, --video: video directory
This provides the user the ability to specify where the videos are located. **It is only used if the program is run stand-alone outside of its Docker container, which is not recommended.** 0
This is *never* needed if the program is run from its Docker container, as the video location would be provided in the ```docker-compose.yml``` file, as decribed above.

### -p, --print: print status dialogues to screen
This takes no arguments; passing it will print updates of successful file reading and writing to the screen.

Example:
```shell
docker-compose run framextract --file databaseFilename.ext --window 5 --print
```

### -h, --help: help string
Displays the help documentation.

*This program remains under active development. This page will be updated as the script evolves.*

# Disclaimer
This repository is a scientific product and is not official communication of the National Oceanic and Atmospheric Administration, or the United States Department of Commerce. All NOAA GitHub project code is provided on an ‘as is’ basis and the user assumes responsibility for its use. Any claims against the Department of Commerce or Department of Commerce bureaus stemming from the use of this GitHub project will be governed by all applicable Federal law. Any reference to specific commercial products, processes, or services by service mark, trademark, manufacturer, or otherwise, does not constitute or imply their endorsement, recommendation or favoring by the Department of Commerce. The Department of Commerce seal and logo, or the seal and logo of a DOC bureau, shall not be used in any manner to imply endorsement of any commercial product or activity by DOC or the United States Government.
